<ui-modal *ngIf="store.state.playerInfo.playerLoading">
  <div class="player-loading">
    <img [src]="store.state.fileInfo[store.state.fileInfo.length - 1].fileThumb">
    <p>{{ 'VIDEO_PLAYER.LOADING' | translate: { current: this.videoFileOpenT - this.videoFileOpen.length, total: this.videoFileOpenT } }}</p>
  </div>
</ui-modal>
<ui-modal *ngIf="store.state.playerInfo.playerLoaded && (videoFileCompatible || videoFileIncompatible)">
  <div class="player-compatibility">
    <div *ngIf="videoFileCompatible">
      <p>{{ 'VIDEO_SEGMENTS.COMPATIBLE.FIRST' | translate }}</p>
      <p>{{ 'VIDEO_SEGMENTS.COMPATIBLE.SECOND' | translate }}</p>
    </div>
    <span *ngIf="videoFileCompatible && videoFileIncompatible"></span>
    <div *ngIf="videoFileIncompatible">
      <p>{{ 'VIDEO_SEGMENTS.INCOMPATIBLE.FIRST' | translate }}</p>
      <p>{{ 'VIDEO_SEGMENTS.INCOMPATIBLE.SECOND' | translate }}</p>
    </div>
    <ui-button buttonColor="success" buttonIcon="done" (click)="videoFileCompatibility()">{{ 'GENERAL.OK' | translate }}</ui-button>
  </div>
</ui-modal>
<div class="flex">
  <div id="playerEdit" class="player-edit" [class]="videoSegments.videoSegments ? 'h-[calc(100%-186px)] w-[calc(100%-316px)]' : 'h-[calc(100%-100px)] w-full'">
    <div id="playerContainer" class="player-video" [class]="store.state.playerInfo.playerLoaded ? 'flex' : 'hidden'">
      <div id="$playerContainer" class="player-video flex">
        <div *ngFor="let file of store.state.fileInfo; index as i" class="contents">
          <video [hidden]="!store.state.playerInfo.playerLoaded || i != store.i" [muted]="true"
            [src]="file.filePath" (loadedmetadata)="$videoFileLoaded($event)" (timeupdate)="null"></video>
        </div>
      </div>
      <div id="playerCrop" [hidden]="!filters.filterInfo.filterCrop" [tooltip]="playerCrop" [tooltipKeep]="true"
        tooltipPlace="bottom" tooltipTheme="tooltip-lite" tooltipTrigger="mouseenter" class="resizable"></div>
      <div #playerCrop class="player-crop">
        <div>
          <div>
            <p>W:</p>
            <input [(ngModel)]="store.state.filterInfo.filterWidth" (input)="videoSetCoordinates('w', $event)"
              min="0" [max]="store.state.playerInfo.playerWidth" type="number">
          </div>
          <div>
            <p>H:</p>
            <input [(ngModel)]="store.state.filterInfo.filterHeight" (input)="videoSetCoordinates('h', $event)"
              min="0" [max]="store.state.playerInfo.playerHeight" type="number">
          </div>
        </div>
        <span></span>
        <div>
          <div>
            <p>X:</p>
            <input [(ngModel)]="store.state.filterInfo.filterX" type="number" (input)="videoSetCoordinates('x', $event)"
              min="0" [max]="store.state.playerInfo.playerWidth - store.state.filterInfo.filterWidth">
          </div>
          <div>
            <p>Y:</p>
            <input [(ngModel)]="store.state.filterInfo.filterY" type="number" (input)="videoSetCoordinates('y', $event)"
              min="0" [max]="store.state.playerInfo.playerHeight - store.state.filterInfo.filterHeight">
          </div>
        </div>
      </div>
    </div>
    <div *ngIf="videoSegments" [class]="$videoSegments.videoSegments ? 'flex' : 'hidden'" class="player-segments">
      <div class="flex">
        <ui-button buttonColor="dark" buttonIcon="next" buttonIconClass="-scale-x-100" [buttonTooltip]="'VIDEO_SEGMENTS.FRAME_ADVANCE.PREV' | translate" (click)="videoPlayerFrame(0)"></ui-button>
        <ui-button buttonColor="dark" buttonIcon="next" [buttonTooltip]="'VIDEO_SEGMENTS.FRAME_ADVANCE.NEXT' | translate" (click)="videoPlayerFrame(1)"></ui-button>
        <p>{{ (playerInfo.playerVideo[store.i]?.currentTime * store.state.videoInfo[store.i]?.videoFrameRate) | number: '1.1-1' }} / {{ (playerInfo.playerVideo[store.i]?.duration * store.state.videoInfo[store.i]?.videoFrameRate) | number: '1.1-1' }}</p>
      </div>
      <div>
        <ui-button buttonColor="dark" buttonIcon="split" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_SPLIT.' | translate" [dropdown]="clipSplit"></ui-button>
        <div #clipSplit>
          <div dropdownIgnore class="player-split">
            <input dropdownIgnore [(ngModel)]="$videoSegments.videoSplit" (input)="$videoSegments.$videoSplit($event)" min="2" [max]="100" type="number">
          </div>
          <span (click)="$videoSegments.$videoClipSplit(0)">{{ 'VIDEO_SEGMENTS.CLIP_SPLIT.NUMBER' | translate: { number: $videoSegments.videoSplit } }}</span>
          <div class="tippy-separator"></div>
          <span (click)="$videoSegments.$videoClipSplit(1)">{{ 'VIDEO_SEGMENTS.CLIP_SPLIT.CURRENT' | translate }}</span>
        </div>
        <div class="player-separator-dark"></div>
        <ui-button buttonColor="dark" buttonIcon="clip-set" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_SET.START' | translate" (click)="$videoSegments.videoClipSet(1)"></ui-button>
        <ui-button buttonColor="dark" buttonIcon="clip-set" buttonIconClass="-scale-x-100" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_SET.END' | translate" (click)="$videoSegments.videoClipSet(0)"></ui-button>
        <div class="player-separator-dark"></div>
        <ui-button buttonColor="dark" buttonIcon="clip-nav" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_NAV.' | translate" [dropdown]="clipNavStart"></ui-button>
        <div #clipNavStart>
          <span (click)="$videoSegments.videoClipNavigate(1, 1)">{{ 'VIDEO_SEGMENTS.CLIP_NAV.START.CLIP' | translate }}</span>
          <div class="tippy-separator"></div>
          <span (click)="$videoSegments.videoClipNavigate(1, 0)">{{ 'VIDEO_SEGMENTS.CLIP_NAV.START.KEYFRAME' | translate }}</span>
        </div>
        <ui-button buttonColor="dark" buttonIcon="clip-nav" buttonIconClass="-scale-x-100" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_NAV.' | translate" [dropdown]="clipNavEnd"></ui-button>
        <div #clipNavEnd>
          <span (click)="$videoSegments.videoClipNavigate(0, 1)">{{ 'VIDEO_SEGMENTS.CLIP_NAV.END.CLIP' | translate }}</span>
          <div class="tippy-separator"></div>
          <span (click)="$videoSegments.videoClipNavigate(0, 0)">{{ 'VIDEO_SEGMENTS.CLIP_NAV.END.KEYFRAME' | translate }}</span>
        </div>
        <ui-button buttonColor="dark" buttonIcon="clip-snap" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_SNAP.START.' | translate" [dropdown]="clipSnapStart"></ui-button>
        <div #clipSnapStart>
          <span (click)="$videoSegments.videoClipSnap(1, 1)">{{ 'VIDEO_SEGMENTS.CLIP_SNAP.START.CLIP' | translate }}</span>
          <div class="tippy-separator"></div>
          <span (click)="$videoSegments.videoClipSnap(1, 0)">{{ 'VIDEO_SEGMENTS.CLIP_SNAP.START.KEYFRAME' | translate }}</span>
        </div>
        <ui-button buttonColor="dark" buttonIcon="clip-snap" buttonIconClass="-scale-x-100" [buttonTooltip]="'VIDEO_SEGMENTS.CLIP_SNAP.END.' | translate" [dropdown]="clipSnapEnd"></ui-button>
        <div #clipSnapEnd>
          <span (click)="$videoSegments.videoClipSnap(0, 1)">{{ 'VIDEO_SEGMENTS.CLIP_SNAP.END.CLIP' | translate }}</span>
          <div class="tippy-separator"></div>
          <span (click)="$videoSegments.videoClipSnap(0, 0)">{{ 'VIDEO_SEGMENTS.CLIP_SNAP.END.KEYFRAME' | translate }}</span>
        </div>
      </div>
    </div>
    <div *ngIf="!store.state.playerInfo.playerLoaded" class="player-open">
      <div [class]="store.state.playerInfo.playerLoading ? 'hidden' : 'flex'">
        <img [src]="'/assets/images/open.svg'">
        <h1>{{ 'VIDEO_PLAYER.FILE_OPEN.TITLE' | translate }}</h1>
        <p>{{ 'VIDEO_PLAYER.FILE_OPEN.SUB' | translate }}</p>
        <span></span>
      </div>
      <input title="" type="file" multiple (change)="$videoFileOpen($event)" />
    </div>
  </div>
  <video-segments #videoSegments (added)="$videoFileOpen($event)" (inited)="$videoSegments = videoSegments"
    (loaded)="videoSetPosition(filters.filterInfo.filterRotate)" (removed)="videoFileClose()"></video-segments>
</div>
<div class="player-controls" [ngClass]="[videoSegments.videoSegments ? 'h-[106px]' : 'h-[70px]', !store.state.playerInfo.playerLoaded ? 'pointer-events-none' : '']">
  <div class="player-buttons">
    <div class="flex">
      <ui-button buttonColor="dark" [buttonIcon]="(!playerInfo.playerVideo[store.i] || playerInfo.playerVideo[store.i].paused) || playerInfo.playerVideo[store.i]?.ended ? 'play' : 'pause'"
        [buttonToggle]="playerInfo.playerVideo[store.i] && !playerInfo.playerVideo[store.i].paused" [buttonTooltip]="'VIDEO_PLAYER.PLAY_PAUSE' | translate" (click)="videoPlayerPlay()"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="stop" [buttonTooltip]="'VIDEO_PLAYER.STOP' | translate" (click)="videoPlayerStop()"></ui-button>
      <ui-button buttonColor="dark" [buttonIcon]="playerInfo.playerVideo[store.i]?.muted || playerInfo.playerVideo[store.i]?.volume == 0 ? 'mute' : 'volume'"
        [tooltip]="playerVolume" [tooltipDelay]="[0, 0]" [tooltipKeep]="true" (click)="videoPlayerMute()"></ui-button>
      <div #playerVolume>
        <ui-slider *ngIf="playerInfo.playerVideo[store.i]" [sliderValue]="playerInfo.playerVideo[store.i].volume * 100" (sliderValueChange)="videoPlayerVolume($event / 100)" [sliderVertical]="true"></ui-slider>
      </div>
      <p>{{ (playerInfo.playerVideo[store.i]?.currentTime || 0) | duration: true }} / {{ (playerInfo.playerVideo[store.i]?.duration || 0) | duration: true }}</p>
    </div>
    <div>
      <ui-button buttonColor="dark" buttonIcon="capture" [buttonTooltip]="'VIDEO_PLAYER.CAPTURE' | translate" (click)="videoCapture.$videoCapture()"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="segments" [buttonToggle]="$videoSegments.videoSegments" [buttonTooltip]="'VIDEO_PLAYER.SPLIT_MERGE' | translate" (click)="$videoSegments.$videoSegments()"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="list" [buttonTooltip]="'VIDEO_PLAYER.LIST' | translate" (click)="$videoInfo.$videoInfo()"></ui-button>
      <div class="player-separator-lite"></div>
      <ui-button buttonColor="dark" buttonIcon="rotate" buttonIconClass="-scale-x-100" [buttonTooltip]="'VIDEO_PLAYER.ROTATE_CCW' | translate" (click)="videoFilterRotate(false)"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="rotate" [buttonTooltip]="'VIDEO_PLAYER.ROTATE_CW' | translate" (click)="videoFilterRotate(true)"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="flip" buttonIconClass="rotate-90" [buttonTooltip]="'VIDEO_PLAYER.FLIP_V' | translate" (click)="videoFilterFlip(true)"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="flip" [buttonTooltip]="'VIDEO_PLAYER.FLIP_H' | translate" (click)="videoFilterFlip(false)"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="crop" [buttonToggle]="filters.filterInfo.filterCrop" [buttonTooltip]="'VIDEO_PLAYER.CROP' | translate" (click)="videoFilterCrop()"></ui-button>
      <div class="player-separator-lite"></div>
      <ui-button buttonColor="dark" buttonIcon="done" [buttonTooltip]="'VIDEO_PLAYER.DONE' | translate" (click)="$videoSave.$videoSave()"></ui-button>
      <ui-button buttonColor="dark" buttonIcon="close" [buttonTooltip]="'VIDEO_PLAYER.CLOSE' | translate" (click)="videoFileClose()"></ui-button>
    </div>
  </div>
  <ui-progress [progressTime]="playerInfo.playerVideo[store.i]?.currentTime" [progressDuration]="playerInfo.playerVideo[store.i]?.duration" [progressExtend]="videoSegments.videoSegments"
    [progressFrames]="store.state.videoInfo[store.i]?.videoKeyFrames" (progressTimeChange)="playerInfo.playerVideo[store.i].currentTime = $event"></ui-progress>
  <div id="playerClip" class="player-clips" [class]="!videoSegments.videoSegments ? store.state.fileInfo[0]?.fileClips[0]?.e ? 'hidden' : 'flex mt-0' : 'flex h-8 mt-4'">
    <div *ngFor="let file of store.state.fileInfo; index as i" [hidden]="i != store.i">
      <div *ngFor="let clip of file.fileClips; index as k">
        <div #playerClip rendered (rendered)="$videoSegments.videoClipCreate($event)" (mousedown)="store.state.fileInfo[i].fileIndex = k"
          [tooltip]="playerClip_" tooltipFollow="horizontal" [tooltipKeep]="true" tooltipPlace="bottom" tooltipTheme="tooltip-lite" tooltipTrigger="mouseenter"
          [ngStyle]="{ 'border-color': k == file.fileIndex ? store.state.colorInfo[file.fileClips[k].color][500] : store.state.colorInfo[file.fileClips[k].color][700] }"
          [class]="k == file.fileIndex ? 'cursor-move opacity-90 z-10' : 'cursor-pointer opacity-80'"></div>
        <div #playerClip_ class="player-clip">
          <div>
            <div>
              <p [title]="'VIDEO_SEGMENTS.CLIP_MANUAL.POSITION' | translate">-->[</p>
              <input [ngModel]="clip.start / store.state.videoInfo[i].videoFrameRate | duration: true" type="time" step="0.001"
                (input)="$videoSegments.videoClipManualInput(0, $event, k, playerClip)"
                (keyup)="$videoSegments.videoClipManualKeyUp(0, $event, k, playerClip)"
                (keydown)="$videoSegments.videoClipManualKeyDown()">
            </div>
            <div>
              <p [title]="'VIDEO_SEGMENTS.CLIP_MANUAL.START' | translate">[--></p>
              <input [ngModel]="clip.start / store.state.videoInfo[i].videoFrameRate | duration: true" type="time" step="0.001"
                (input)="$videoSegments.videoClipManualInput(1, $event, k, playerClip)"
                (keyup)="$videoSegments.videoClipManualKeyUp(1, $event, k, playerClip)"
                (keydown)="$videoSegments.videoClipManualKeyDown()">
            </div>
            <div>
              <p [title]="'VIDEO_SEGMENTS.CLIP_MANUAL.END' | translate"><--]</p>
              <input [ngModel]="clip.end / store.state.videoInfo[i].videoFrameRate | duration: true" type="time" step="0.001"
                (input)="$videoSegments.videoClipManualInput(2, $event, k, playerClip)"
                (keyup)="$videoSegments.videoClipManualKeyUp(2, $event, k, playerClip)"
                (keydown)="$videoSegments.videoClipManualKeyDown()">
            </div>
            <div>
              <p [title]="'VIDEO_SEGMENTS.CLIP_MANUAL.LENGTH' | translate"><--></p>
              <input [ngModel]="(clip.end - clip.start) / store.state.videoInfo[i].videoFrameRate | duration: true" type="time" step="0.001"
                (input)="$videoSegments.videoClipManualInput(3, $event, k, playerClip)"
                (keyup)="$videoSegments.videoClipManualKeyUp(3, $event, k, playerClip)"
                (keydown)="$videoSegments.videoClipManualKeyDown()">
            </div>
          </div>
          <span></span>
          <div>
            <div>
              <input [ngModel]="clip.start | numberInput: '1.0-1'" (input)="$videoSegments.videoClipManualFrame(0, $event, k, playerClip)" type="number" min="0">
            </div>
            <div>
              <input [ngModel]="clip.start | numberInput: '1.0-1'" (input)="$videoSegments.videoClipManualFrame(1, $event, k, playerClip)" type="number" min="0">
            </div>
            <div>
              <input [ngModel]="clip.end | numberInput: '1.0-1'" (input)="$videoSegments.videoClipManualFrame(2, $event, k, playerClip)" type="number" min="0">
            </div>
            <div>
              <input [ngModel]="(clip.end - clip.start) | numberInput: '1.0-1'" (input)="$videoSegments.videoClipManualFrame(3, $event, k, playerClip)" type="number" min="0">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<video-capture #videoCapture [currentTime]="playerInfo.playerVideo[store.i]?.currentTime"></video-capture>
<video-info #videoInfo (inited)="$videoInfo = videoInfo" (loaded)="videoFileLoaded()"></video-info>
<video-save #videoSave *ngIf="store.state.playerInfo.playerLoaded" (loaded)="$videoSave = videoSave"></video-save>